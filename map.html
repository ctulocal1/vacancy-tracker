<!DOCTYPE HTML>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Map Experiment</title>
</head>
<body>
    <div id="dataOutput">
<table id="0">
<thead>
<caption>Chicago Citywide Data</caption>
</thead>
<tbody>
</tbody>
</table>
    </div>
    <figure id="cpsmap"></figure>
    <style>
    #cpsmap {
      height: 96vh;
    }
    #cpsmap #networks path:hover {
      fill: red;
    }
    #cpsmap #offices g {
      display: none;
    }
    #dataOutput {
      width: 100vw;
      min-width: 600px;
      font-family: sans-serif;
    }
    #dataOutput table {
      min-width: 300px;
      font-size: 18px;
    }
    #dataOutput table tr {
      border-bottom: 1px solid #dddddd;
    }
    #dataOutput table caption {
      text-align: left;
      font-size: 32px;
      border-bottom: 3px solid #333333;
      white-space: nowrap;
    }
    #dataOutput table td:nth-child(2) {
      padding-left: 10px;
      text-align: right;
    }
    </style>
    <script>
    async function getData() {
      const url = "./schools-repped.json";
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Response status: ${response.status}`);
        }
        const data = await response.json();
        return data;
      } catch (error) {
        console.error(error.message);
      }
    }
    async function getVacancies() {
      const url = "./schools-vacancies.json";
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Response status: ${response.status}`);
        }
        const data = await response.json();
        return data;
      } catch (error) {
        console.error(error.message);
      }
    }
    async function getMap() {
      const url = "./cps-map.svg";
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Response status: ${response.status}`);
        }
        const map = await response.text();
        return map;
      } catch (error) {
        console.error(error.message);
      }
    }
    let cpsmap = document.getElementById("cpsmap");
    let schoolsData = getData()
    .then(schoolsData => {
      let vacanciesData = getVacancies()
      .then ( vacanciesData => {
        getMap()
          .then(svg => {
            cpsmap.innerHTML=svg;
          })
          .then(() => {
            let schoolGroups = document.querySelectorAll("#cpsmap #schools g");
            schoolGroups.forEach((group) => {
              const schoolNumber = parseInt( group.id );
              const schoolMatch = schoolsData.filter((school) => school.school_id === group.id);
              if (schoolMatch.length < 1) {
                group.style.display = "none";
              } else {
                const schoolData = schoolMatch[0];
                const schoolVacancyData = vacanciesData.find(school => school.school_id === schoolData.school_id);
                const schoolMembers = parseInt( schoolVacancyData.ActiveMemb );
                const schoolVacancies = parseInt( schoolVacancyData.TotVacancy ); 
                const schoolVacancyPercent = Math.round(schoolVacancies*1000/schoolMembers) / 10.0;
                let dataTable = `
<table id="${schoolData.school_id}">
<thead>
<caption>${schoolData.short_name}</caption>
</thead>
<tbody>
<tr><td colspan="2">Address: ${schoolData.address}</td></tr>
<tr><td>Members Positions at School:</td><td>${schoolMembers}&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>Vacancies at School</td><td>${schoolVacancies}&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>Percentage Vacant:</td><td>${schoolVacancyPercent}%</td></tr>
</tbody>
</table>
`;
                group.addEventListener("click", (e) => {
                  let dataOutput = document.querySelector("#dataOutput");
                  dataOutput.innerHTML = dataTable;
                });
                let circle = group.querySelector("circle");
                circle.setAttributeNS(null,"r",Math.sqrt(schoolMembers/5));
                if (schoolVacancies < 1) { 
                  circle.style.fill = "#009966";
                } else if (schoolVacancyPercent < 5) {
                  circle.style.fill="#99ccaa";
                } else if (schoolVacancyPercent < 10) {
                  circle.style.fill="#ffffaa";
                } else if (schoolVacancyPercent < 20) {
                  circle.style.fill="#ffaaaa";
                }
              }
            });
            const cityMembers = vacanciesData.reduce( (a,c) => a + parseInt( c.ActiveMemb ),0);
            const cityVacancies = vacanciesData.reduce ( (a,c) => a + parseFloat( c.TotVacancy ),0.0);
            const cityVacancyPercent = Math.round( cityVacancies * 1000 / cityMembers ) / 10;
            let dataTable = `
<table id="citywide">
<thead>
<caption>Citywide Vacancy Data</caption>
</thead>
<tbody>
<tr><td>Member Positions Citywide:</td><td>${cityMembers.toLocaleString()}&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>Vacancies Citywide:</td><td>${cityVacancies.toLocaleString()}&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>Percent Vacant:</td><td>${cityVacancyPercent}%</td></tr>
</tbody>
</table>
`;
            dataOutput.innerHTML = dataTable;
          });
      });
    });
    </script>
</body>
</html>
