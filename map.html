<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Map Experiment</title>
  </head>
  <body>
    <div id="dataOutput">
      <table id="0">
        <thead>
          <caption>Chicago Citywide Data</caption>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
    <figure id="cpsmap"></figure>
    <style>
    #cpsmap {
      height: 96vh;
    }
    #cpsmap #offices g {
      display: none;
    }
    #cpsmap #networks path {
      fill-opacity: 0.09;
    }
    #dataOutput {
      width: 100vw;
      min-width: 600px;
      font-family: sans-serif;
    }
    #dataOutput table {
      min-width: 300px;
      font-size: 18px;
    }
    #dataOutput table tr {
      border-bottom: 1px solid #dddddd;
    }
    #dataOutput table caption {
      text-align: left;
      font-size: 32px;
      border-bottom: 3px solid #333333;
      white-space: nowrap;
    }
    #dataOutput table td:nth-child(2) {
      padding-left: 10px;
      text-align: right;
    }
    </style>
    <script>
    async function getData() {
    const url = "./schools.json";
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Response status: ${response.status}`);
        }
        const data = await response.json();
        return data;
      } catch (error) {
        console.error(error.message);
      }
    }
    async function getVacancies() {
      const url = "./schools-vacancies.json";
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Response status: ${response.status}`);
        }
        const data = await response.json();
        console.log(data);
        return data;
      } catch (error) {
        console.error(error.message);
      }
    }
    async function getMap() {
      const url = "./cps-map.svg";
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Response status: ${response.status}`);
        }
        const map = await response.text();
        return map;
      } catch (error) {
        console.error(error.message);
      }
    }
    let cpsmap = document.getElementById("cpsmap");
    let schoolsData = getData()
    .then(schoolsData => {
      let vacanciesData = getVacancies()
      .then ( vacanciesData => {
        getMap()
          .then(svg => {
            cpsmap.innerHTML=svg;
          })
          .then(() => {
            const cityMembers = vacanciesData.reduce( (a,c) => a + parseInt( c.ActiveMemb ),0);
            const cityVacancies = vacanciesData.reduce ( (a,c) => a + parseFloat( c.TotVacancy ),0.0);
            const cityVacancyPercent = Math.round( cityVacancies * 1000 / cityMembers ) / 10;
            let dataTable = `
<table id="citywide">
<thead>
<caption>Citywide Vacancy Data</caption>
</thead>
<tbody>
<tr><td>Member Positions Citywide:</td><td>${cityMembers.toLocaleString()}&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>Vacancies Citywide:</td><td>${cityVacancies.toLocaleString()}&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>Percent Vacant:</td><td>${cityVacancyPercent}%</td></tr>
</tbody>
</table>
`;
            dataOutput.innerHTML = dataTable;
            let schoolGroups = document.querySelectorAll("#cpsmap #schools g");
            schoolGroups.forEach((group) => {
              const schoolNumber = parseInt( group.id );
              const schoolMatch = schoolsData.filter((school) => school.school_id === group.id);
              if (schoolMatch.length < 1) {
                group.style.display = "none";
              } else {
                const schoolData = schoolMatch[0];
                const schoolVacancyData = vacanciesData.find(school => school.school_id === schoolData.school_id);
                if (!schoolVacancyData) {
                  group.style.display = "none";
                  console.error("Vacancy Data Not Found for",schoolData.name_short)
                } else {
                  const schoolMembers = parseInt( schoolVacancyData.ActiveMemb );
                  const schoolVacancies = parseInt( schoolVacancyData.TotVacancy ); 
                  const schoolVacancyPercent = Math.round(schoolVacancies*1000/schoolMembers) / 10.0;
                  let dataTable = `
<table id="${schoolData.school_id}">
<thead>
<caption>${schoolData.name_short}</caption>
</thead>
<tbody>
<tr><td colspan="2">Address: ${schoolData.address}</td></tr>
<tr><td>Members Positions at School:</td><td>${schoolMembers}&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>Vacancies at School</td><td>${schoolVacancies}&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>Percentage Vacant:</td><td>${schoolVacancyPercent}%</td></tr>
</tbody>
</table>
`;
                  group.addEventListener("click", (e) => {
                    let dataOutput = document.querySelector("#dataOutput");
                    dataOutput.innerHTML = dataTable;
                  });
                  let circle = group.querySelector("circle");
                  circle.setAttributeNS(null,"r",Math.sqrt(schoolMembers/5));
                  if (schoolVacancies < 1) { 
                    circle.style.fill = "#009966";
                  } else if (schoolVacancyPercent < 5) {
                    circle.style.fill="#99ccaa";
                  } else if (schoolVacancyPercent < 10) {
                    circle.style.fill="#ffffaa";
                  } else if (schoolVacancyPercent < 20) {
                    circle.style.fill="#ffaaaa";
                  }
                }
              }
            });
            let nets = document.querySelectorAll("#cpsmap #networks path");
            nets.forEach( (net) => {
              const intRegex = /[0-9]+/g;
              const netNumber = parseInt( net.id.match(intRegex) );
              const schoolMatches = schoolsData.filter((school) => parseInt( school.network_es ) === netNumber);
              console.log("Network:",netNumber,"Schools:",schoolMatches);
              let netData = {members:0,vacancies:0};
              if (schoolMatches.length < 1) {
                net.style.fill="#bbaaff";
                console.error("No schools found in Network",netNumber);
              } else {
                netData.members = schoolMatches.reduce( (members,schoolData) => {
                    let schoolVacancyDatum = vacanciesData.find(school => {
                    return parseInt( school.school_id ) === parseInt( schoolData.school_id ) });
                  let activeMembers = 0;
                  if (schoolVacancyDatum) {
                    activeMembers = parseInt( schoolVacancyDatum.ActiveMemb);
                  }
                    return members + activeMembers;
                }, 0);
                console.log("Network",netNumber,"Member Total:",netData.members);
                netData.vacancies = schoolMatches.reduce( (vacancies,schoolData) => {
                    const schoolVacancyDatum = vacanciesData.find(school => parseInt( school.school_id ) === parseInt( schoolData.school_id ));
                  let schoolVacancies = 0;
                  if (schoolVacancyDatum) {
                    schoolVacancies = parseInt( schoolVacancyDatum.TotVacancy);
                  }
                    return vacancies + schoolVacancies;
                }, 0);
                console.log(netData);
                const netVacancyPercent = Math.round(netData.vacancies * 1000 / netData.members) / 10.0;
                let dataTable = `
<table id="network${netNumber}">
<thead>
<caption>Network ${netNumber}</caption>
</thead>
<tbody>
<tr><td>Members Positions in Network:</td><td>${netData.members}&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>Vacancies in Network</td><td>${netData.vacancies}&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>Percent Vacant:</td><td>${netVacancyPercent}%</td></tr>
</tbody>
</table>
`;
                  net.addEventListener("click", (e) => {
                    let dataOutput = document.querySelector("#dataOutput");
                    dataOutput.innerHTML = dataTable;
                  });
                console.log(netVacancyPercent);
                  if (netVacancyPercent === 0) { 
                    net.style.fill = "#009966";
                  } else if (netVacancyPercent < 5) {
                    net.style.fill="#99ccaa";
                  } else if (netVacancyPercent < 10) {
                    net.style.fill="#ffffaa";
                  } else if (netVacancyPercent < 20) {
                    net.style.fill="#ffaaaa";
                  } else net.style.fill = "dd6666";
              }
            });
          });
      });
    });
    </script>
  </body>
</html>
