<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>CTU Vacancy Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <link rel="shortcut icon" href="/images/ctu-seal.png" type="image/png">
  </head>
  <body>
    <header style="height: 120px;">
      <h2>Does this change anything?</h2>
      <img src="/images/ctu-logo.png" alt="Chicago Teachers Union" style="height: 100px;">
    </header>
    <dialog id="modal" class="modal">
      <div class="modal-inner">
        <form id="modal-form">
          <button type="button" aria-label="close" formmethod="dialog" class="modal-close" formnovalidate="">×</button>
          <div id="modal-content"></div>
        </form>
      </div>
    </dialog>
    <div class="grid-container">
      <header>
        <h1>Vacancy Tracker</h1>
        <p><strong>The Chicago Teachers Union is fighting for the schools Chicago&rsquo;s students deserve.</strong> Chicago Public Schools CEO Pedro Martinez claims that the district has improved services by allocating new positions, but the reality is that many of these positions exist on paper only. See the difference between the staffing CPS <em>says</em> it is providing and the number of clinicians, teachers, teacher assistants and all school staff <em>actually working</em> at any given school, network office, citywide job category or throughout an elementary network region. These vacant position numbers were provided by CPS itself, so if you can either confirm or correct it, please click the appropriate button below the data table.</p>
      </header>
      <div id="text" class="text">
        <label for="cb1-input">Display data for:</label>
        <div class="combobox combobox-list">
          <div class="group">
            <input id="cb1-input" class="cb_edit" type="text" role="combobox" aria-autocomplete="both" aria-expanded="false" aria-controls="cb1-listbox">
            <button type="button" id="cb1-button" aria-label="Schools" aria-expanded="false" aria-controls="cb1-listbox" tabindex="-1">
              <svg width="18" height="16" aria-hidden="true" focusable="false" style="forced-color-adjust: auto">
                <polygon class="arrow" stroke-width="0" fill-opacity="0.75" fill="currentcolor" points="3,6 15,6 9,14"></polygon>
              </svg>
            </button>
          </div>
          <ul id="choiceList" role="listbox" aria-label="Schools">
          </ul>
        </div>
        <output for="cb1-input" id="dataOutput" class="dataOutput">
          <table id="0">
            <thead>
              <caption><div>Chicago Citywide Data</div></caption>
            </thead>
            <tbody>
            </tbody>
          </table>
        </output>
      </div>
      <figure id="cpsmap" class="cpsmap"></figure>
    </div>
    <style>
body {
  font-family: 'Open Sans',sans-serif;
  padding: 0;
  margin: 0;
  box-sizing: border-box;
}
body * {
  box-sizing: border-box;
}
h1 {
  margin-top: 0;
  padding-top: 0;
  line-height: 1.3;
}
.cpsmap {
  width: 100%;
  margin:0;
  padding:0;
  position: relative;
}
.cpsmap svg {
  margin: 0;
  height: auto;
  max-height: 100%;
  max-width: 100%;
  position: absolute;
}
input.deptChoice {
  width: 100%;
  height: 10vw;
  font-size: 8vw;
  line-height: 1.0;
  margin: 10px 0;
}
.cpsmap #offices g {
  display: none;
}
.cpsmap #networks path {
  fill-opacity: 0.09;
}
.dataOutput {
  width: 100%;
  max-width: 460px;
  margin: 20px 0;
}
.dataOutput table {
  width: calc(100vw - 80px);
  max-width: 460px;
  font-size: 18px;
  border-collapse: collapse;
}
.dataOutput table tr.remove {
  border-bottom: 1px solid #dddddd;
}
.dataOutput table caption {
  width: 100%;
  height: 2.6em;
  border-bottom: 3px solid #333333;
  position: relative;
}
.dataOutput table caption div {
  width: 100%;
  text-align: left;
  text-wrap: balance;
  font-size: 24px;
  line-height: 1.3;
  position: absolute;
  bottom: 0;
}
.dataOutput table tbody {
  width: 100%;
}
.dataOutput table th,
.dataOutput table td {
  margin:0;
  padding-right: 10px;
  text-align: right;
  border: none;
}
.dataOutput table th {
  font-weight: 500;
}
.dataOutput table th[scope="col"] {
  border-bottom: 1px solid #333333;
}
.dataOutput table th[scope="row"] {
  text-align: left;
}
.grid-container {
  width: calc(100vw - 40px);
  padding: 0 20px;
  border: none;
  margin: 0;
  display: grid;
  grid-template-areas: "header" "legend" "map";
  grid-template-columns: 1fr;
  gap: 20px;
  background: white;
}
.grid-container header {
  padding: 0 10px 0 0;
  grid-area: header;
}
.grid-container header p {
  line-height: 1.4;
}
.grid-container .text {
  grid-area: legend;
  padding-top: 0;
}
.grid-container .cpsmap {
  grid-area: map;
  width: calc(100vw - 40px);
  height: fit-content;
  min-height: 110vw;
}

.combobox-list {
  width: 100%;
  position: relative;
  z-index: 2;
}

.combobox .group {
  display: inline-flex;
  padding: 4px;
  cursor: pointer;
}

.combobox input,
.combobox button {
  background-color: white;
  color: black;
  box-sizing: border-box;
  height: 30px;
  padding: 0;
  margin: 0;
  vertical-align: bottom;
  border: 1px solid gray;
  position: relative;
  cursor: pointer;
}

.combobox input {
  width: calc(100vw - 80px);
  border-right: none;
  outline: none;
  font-size: 87.5%;
  padding: 1px 3px;
}

.combobox button {
  width: 19px;
  border-left: none;
  outline: none;
  color: rgb(0 90 156);
}

.combobox button[aria-expanded="true"] svg {
  transform: rotate(180deg) translate(0, -3px);
}

ul[role="listbox"] {
  margin: 0;
  padding: 0;
  position: absolute;
  left: 4px;
  top: 34px;
  list-style: none;
  background-color: white;
  display: none;
  box-sizing: border-box;
  border: 2px currentcolor solid;
  max-height: 250px;
  width: 168px;
  overflow: scroll;
  overflow-x: hidden;
  font-size: 87.5%;
  cursor: pointer;
  width: calc(100% - 8px);
}

ul[role="listbox"] li[role="option"] {
  margin: 0;
  display: block;
  padding-left: 3px;
  padding-top: 2px;
  padding-bottom: 2px;
}

/* focus and hover styling */

.combobox .group.focus,
.combobox .group:hover {
  padding: 2px;
  border: 2px solid currentcolor;
  border-radius: 4px;
}

.combobox .group.focus polygon,
.combobox .group:hover polygon {
  fill-opacity: 1;
}

.combobox .group.focus input,
.combobox .group.focus button,
.combobox .group input:hover,
.combobox .group button:hover {
  background-color: #def;
}

[role="listbox"].focus [role="option"][aria-selected="true"],
[role="listbox"] [role="option"]:hover {
  background-color: #def;
  padding-top: 0;
  padding-bottom: 0;
  border-top: 2px solid currentcolor;
  border-bottom: 2px solid currentcolor;
}
dialog {
  width: calc(100vw - 40px);
  max-width: 500px;
  position: relative;
}
dialog input[type="email"] {
  width: 100%;
}
.dialog-close {
  position: absolute;
  top: 10px;
  right: 10px;
  border: 1px solid #777777;
  border-radius: 50%;
  line-height: 0.8;
  font-size: 14px;
  padding: 3px 4px;
}
@media screen and (min-width : 840px) {
  .grid-container {
    max-width: 1100px;
    gap: 40px;
    margin: 40px auto 0 auto;
    grid-template-columns: 3fr 1fr;
    grid-template-areas:
      "header legend"
      "map legend";
  }
  .grid-container header {
    // grid-column: 1/2;
    // grid-row: 1;
  }
  .grid-container .text {
    padding-top: 60px;
  }
  .grid-container .cpsmap {
    margin:0;
    padding:0;
    width: 100%;
    max-height: 700px;
    position: relative;
    // grid-column: 1;
    // grid-row:2;
  }
  .cpsmap svg {
    margin: 0;
    max-height: 100%;
    max-width: 100%;
    position: absolute;
    right: 0;
    top: 0;
    max-height: 700px;
    height: auto;
  }
  .dataOutput {
    display: block;
  }
  .dataOutput table {
    max-width: 340px;
    font-variant-numeric: lining-nums tabular-nums;
  }
  input.deptChoice {
    width: 300px;
    height: auto;
    font-size: 18px;
    line-height: 1.0;
  }
  .combobox input {
    width: 300px;
  }
  .choiceList,
  .choiceList li[role="option"] {
    font-size: 14px;
    height: 20px;
    width: 300px;
  }
}
    </style>
    <script>
  const modal = document.getElementById("modal");
  function openModal() { modal.showModal() }
  function closeModal() { console.log("Closing modal."); modal.close() }
  function clickOutsideToClose(e) {console.log(e); if (e.target.id === 'modal') closeModal() }
  modal.addEventListener("click", clickOutsideToClose);
  const modalCloser = document.querySelector(".modal-close");
  modalCloser.addEventListener("click", closeModal)
  let modalContentBox = document.querySelector("#modal-content");
main ();
async function getData() {
  const url = "./schools.json";
  try {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`Response status: ${response.status}`);
    }
    const data = await response.json();
    return data;
  } catch (error) {
    console.error(error.message);
  }
}
async function getVacancies() {
  const url = "./schools-vacancies.json";
  try {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`Response status: ${response.status}`);
    }
    const data = await response.json();
    console.log("Getting Vacancies:",data);
    return data;
  } catch (error) {
    console.error(error.message);
  }
}
async function getMap() {
  const url = "./cps-map.svg";
  try {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`Response status: ${response.status}`);
    }
    const map = await response.text();
    return map;
  } catch (error) {
    console.error(error.message);
  }
}
async function main () {
  let cpsmap = document.getElementById("cpsmap");
  let dataOutput = document.querySelector("#dataOutput");
  let schoolsData = getData()
  .then(schoolsData => {
    let vacanciesData = getVacancies()
    .then ( vacanciesData => {
      getMap()
        .then(svg => {
          cpsmap.innerHTML=svg;
        })
        .then(() => {
          // Initializing modal stuff -- see bottom for other scripts and styling

          // Joining school data with vacancy data
          let schoolsVacancies = joinVacancies(schoolsData,vacanciesData);
          console.log("schoolsVacancies:",schoolsVacancies);
          initCombobox (schoolsVacancies);

          // Compute citywide data and add it to initial page load
          const cityMembers = vacanciesData.reduce( (a,c) => a + parseInt( c.ActiveMemb ),0);
          const cityVacancies = vacanciesData.reduce ( (a,c) => a + parseFloat( c.TotVacancy ),0.0);
          const cityVacancyPercent = Math.round( cityVacancies * 1000 / cityMembers ) / 10;
          let dataTable = `
<table id="citywide">
<thead>
<caption><div>Citywide Vacancy Data</div></caption>
</thead>
<tbody>
<tr><td>Member Positions Citywide:</td><td>${cityMembers.toLocaleString()}&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>Vacancies Citywide:</td><td>${cityVacancies.toLocaleString()}&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td>Percent Vacant:</td><td>${cityVacancyPercent}%</td></tr>
</tbody>
</table>
`;
          dataOutput.innerHTML = dataTable;

          // Uses groups in the map to query for schools data and attach to map svg group datasets.
          // This is backwards and I will fix it later in the refactor.
          let schoolGroups = document.querySelectorAll("#cpsmap #schools g");
          schoolGroups.forEach((group) => {
            const schoolNumber = parseInt( group.id );
            const schoolMatch = schoolsData.filter((school) => school.school_id === group.id);
            if (schoolMatch.length < 1) {
              group.style.display = "none";
            } else {
              const schoolData = schoolMatch[0];
              const schoolVacancyData = vacanciesData.find(school => school.school_id === schoolData.school_id);
              if (!schoolVacancyData) {
                group.style.display = "none";
                // console.log("Vacancy Data Not Found for",schoolData.name_short)
              } else {
                const schoolMembers = parseInt( schoolVacancyData.ActiveMemb );
                const schoolVacancies = parseInt( schoolVacancyData.TotVacancy ); 
                const schoolVacancyPercent = Math.round(schoolVacancies*1000/schoolMembers) / 10.0;
                let dataTable = `
<table id="${schoolData.school_id}">
<thead>
<caption><div>${schoolData.name_short}</div></caption>
<tr>
<th></th>
<th scope="col" aria-label="Positions">Pos.</th>
<th scope="col" aria-label="Vacancies">Vac.</th>
<th scope="col" aria-label="Vacancy Rate">Rate</th></tr>
</thead>
<tbody>
<tr>
<th scope="row">All Positions:</th>
<td>${schoolMembers}</td>
<td>${schoolVacancies}</td>
<td>${schoolVacancyPercent}%</td>
</tr>
</tbody>
</table>
<form id="report" name="report">
<p>Is this your school? <button class="positive" type="button">&#9989;Yes!</button>
</p>
</form>
`;
                group.addEventListener("click", outputSchoolData, {capture: true});
                group.dataset.members = `${schoolMembers}`;
                group.dataset.vacancy = `${schoolVacancies}`;
                let circle = group.querySelector("circle");
                circle.setAttributeNS(null,"r",Math.sqrt(schoolMembers/5));
                if (schoolVacancies < 1) { 
                  circle.style.fill = "#009966";
                } else if (schoolVacancyPercent < 5) {
                  circle.style.fill="#99ccaa";
                } else if (schoolVacancyPercent < 10) {
                  circle.style.fill="#ffffaa";
                } else if (schoolVacancyPercent < 20) {
                  circle.style.fill="#ffaaaa";
                }
              }
            }
          });
          let nets = document.querySelectorAll("#cpsmap #networks path");
          nets.forEach( (net) => {
            const intRegex = /[0-9]+/g;
            const netNumber = parseInt( net.id.match(intRegex) );
            const schoolMatches = schoolsData.filter((school) => parseInt( school.network_es ) === netNumber);
            // console.log("Network:",netNumber,"Schools:",schoolMatches);
            let netData = {members:0,vacancies:0};
            if (schoolMatches.length < 1) {
              net.style.fill="#bbaaff";
              // console.error("No schools found in Network",netNumber);
            } else {
              netData.members = schoolMatches.reduce( (members,schoolData) => {
                let schoolVacancyDatum = vacanciesData.find(school => {
                  return parseInt( school.school_id ) === parseInt( schoolData.school_id ) });
                let activeMembers = 0;
                if (schoolVacancyDatum) {
                  activeMembers = parseInt( schoolVacancyDatum.ActiveMemb);
                }
                return members + activeMembers;
              }, 0);
              // console.log("Network",netNumber,"Member Total:",netData.members);
              netData.vacancies = schoolMatches.reduce( (vacancies,schoolData) => {
                const schoolVacancyDatum = vacanciesData.find(school => parseInt( school.school_id ) === parseInt( schoolData.school_id ));
                let schoolVacancies = 0;
                if (schoolVacancyDatum) {
                  schoolVacancies = parseInt( schoolVacancyDatum.TotVacancy);
                }
                return vacancies + schoolVacancies;
              }, 0);
              // console.log(netData);
              const netVacancyPercent = Math.round(netData.vacancies * 1000 / netData.members) / 10.0;
              let dataTable = `
<table id="network${netNumber}">
<thead>
<caption><div>Network ${netNumber}</div></caption>
<tr><th></th><th scope="col">Pos.</th><th scope="col">Vac.</th><th scope="col">Rate</th></tr>
</thead>
<tbody>
<tr>
<th scope="row">All Positions:</th>
<td>${netData.members.toLocaleString()}</td>
<td>${netData.vacancies.toLocaleString()}</td>
<td>${netVacancyPercent}%</td>
</tr>
</tbody>
</table>
`;
              net.addEventListener("click", (e) => {
                let dataOutput = document.querySelector("#dataOutput");
                dataOutput.innerHTML = dataTable;
              });
              // console.log(netVacancyPercent);
              if (netVacancyPercent === 0) { 
                net.style.fill = "#009966";
              } else if (netVacancyPercent < 5) {
                net.style.fill="#009966";
              } else if (netVacancyPercent < 10) {
                net.style.fill="#99ffaa";
              } else if (netVacancyPercent < 15) {
                net.style.fill="gold";
              } else if (netVacancyPercent < 20) {
                net.style.fill="#ffaaaa";
              } else net.style.fill = "dd6666";
            }
          });
          const data = new CustomEvent("data");
          window.dispatchEvent(data);
          return "Main finishes inside adding eventlisteners.";
        })
    })
  })
}
    function joinVacancies (schools,vacancies) {
  console.log("joinVacancies | vacancies:",vacancies,"schools:",schools);
  const vacancyJoin = vacancies.map(vacancy => {
    // console.log(vacancy);
    const vacant = vacancy;
    const school = schools.find(school => parseInt(school.school_id) === parseInt(vacant.school_id));
    return {...vacant,...school}
  })
  return vacancyJoin;
}

function outputSchoolData (event) {
  let target;
  if (event instanceof Event) {target = event.currentTarget} else {
    target = event.lastOption;
  }
  const school_id = target.id;
  console.log("Output School Data:",school_id,target.textContent);
  const schoolName = target.textContent;
  const schoolMembers = target.dataset.members;
  const schoolVacancies =  target.dataset.vacancy;
  const schoolVacancyPercent = Math.round(schoolVacancies*1000/schoolMembers) / 10.0;
  let combobox = document.getElementById("cb1-input");
  combobox.value = "";
  let dataTable = `
<table id="${school_id}">
<thead>
<caption><div>${schoolName}</div></caption>
<tr>
<th></th>
<th scope="col">Pos.</th>
<th scope="col">Vac.</th>
<th scope="col">Rate</th>
</tr>
</thead>
<tbody>
<tr>
<th scope="row">All Positions:</th>
<td>${schoolMembers}</td>
<td>${schoolVacancies}</td>
<td>${schoolVacancyPercent}%</td>
</tr>
</tbody>
</table>
<form id="report" name="report">
<p>Is this your school? <button class="positive" type="button" style="font-weight: bold;">&#9989; Yes!</button>
</p>
</form>
`;
  dataOutput.innerHTML = dataTable;
  let reportButtons = document.querySelectorAll("#report button" )
  reportButtons.forEach( (button) => {
    button.dataset.schoolName = schoolName;
    button.dataset.members = schoolMembers;
    button.dataset.vacancies = schoolVacancies;
    button.dataset.rate = schoolVacancyPercent;
    button.addEventListener ("click", reportMessage);
  })
}

function stringPropertySort(a,b,property) {
  // Use this function inside Array.sort() 
  const nameA = a[property].toUpperCase(); // ignore upper and lowercase
  const nameB = b[property].toUpperCase(); // ignore upper and lowercase
  if (nameA < nameB) {
    return -1;
  }
  if (nameA > nameB) {
    return 1;
  }

  // names must be equal
  return 0;
}

function initCombobox (schoolVacancies) {
  const datalist = document.querySelector("#choiceList");
  const vacancies = {};
  vacancies.schools = schoolVacancies;
  console.log("initCombobox schoolVacancies:",schoolVacancies);
  const nameSortedVacancies = vacancies.schools.sort ( (a, b) => stringPropertySort(a,b,"name_short"))
  // console.log("nameSortedVacancies:",nameSortedVacancies);
  nameSortedVacancies.forEach(school => {
    const option = document.createElement("li");
    option.id = `${school.school_id}`;
    option.innerText = school.name_short;
    option.role = "option";
    option.dataset.members = `${school.ActiveMemb}`;
    option.dataset.vacancy = `${school.TotVacancy}`;
    datalist.appendChild(option);
    option.addEventListener("click", outputSchoolData);
  })
  console.log("First Kid:",datalist.children[0])



}


/*
 *   This content is licensed according to the W3C Software License at
 *   https://www.w3.org/Consortium/Legal/2015/copyright-software-and-document
 */

class ComboboxAutocomplete {
  constructor(comboboxNode, buttonNode, listboxNode) {
    this.comboboxNode = comboboxNode;
    this.buttonNode = buttonNode;
    this.listboxNode = listboxNode;

    this.comboboxHasVisualFocus = false;
    this.listboxHasVisualFocus = false;

    this.hasHover = false;

    this.isNone = false;
    this.isList = false;
    this.isBoth = false;

    this.allOptions = [];

    this.option = null;
    this.firstOption = null;
    this.lastOption = null;

    this.filteredOptions = [];
    this.filter = '';

    var autocomplete = this.comboboxNode.getAttribute('aria-autocomplete');

    if (typeof autocomplete === 'string') {
      autocomplete = autocomplete.toLowerCase();
      this.isNone = autocomplete === 'none';
      this.isList = autocomplete === 'list';
      this.isBoth = autocomplete === 'both';
    } else {
      // default value of autocomplete
      this.isNone = true;
    }

    this.comboboxNode.addEventListener(
      'keydown',
      this.onComboboxKeyDown.bind(this)
    );
    this.comboboxNode.addEventListener(
      'keyup',
      this.onComboboxKeyUp.bind(this)
    );
    this.comboboxNode.addEventListener(
      'click',
      this.onComboboxClick.bind(this)
    );
    this.comboboxNode.addEventListener(
      'focus',
      this.onComboboxFocus.bind(this)
    );
    this.comboboxNode.addEventListener('blur', this.onComboboxBlur.bind(this));

    document.body.addEventListener(
      'pointerup',
      this.onBackgroundPointerUp.bind(this),
      true
    );

    // initialize pop up menu

    this.listboxNode.addEventListener(
      'pointerover',
      this.onListboxPointerover.bind(this)
    );
    this.listboxNode.addEventListener(
      'pointerout',
      this.onListboxPointerout.bind(this)
    );

    // Traverse the element children of domNode: configure each with
    // option role behavior and store reference in.options array.
    var nodes = this.listboxNode.getElementsByTagName('LI');

    for (var i = 0; i < nodes.length; i++) {
      var node = nodes[i];
      this.allOptions.push(node);

      node.addEventListener('click', this.onOptionClick.bind(this));
      node.addEventListener('pointerover', this.onOptionPointerover.bind(this));
      node.addEventListener('pointerout', this.onOptionPointerout.bind(this));
    }
    console.log("Combobox Code All Options:",this.allOptions);

    this.filterOptions();

    // Open Button

    var button = this.comboboxNode.nextElementSibling;

    if (button && button.tagName === 'BUTTON') {
      button.addEventListener('click', this.onButtonClick.bind(this));
    }
  }

  getLowercaseContent(node) {
    return node.textContent.toLowerCase();
  }

  isOptionInView(option) {
    var bounding = option.getBoundingClientRect();
    return (
      bounding.top >= 0 &&
        bounding.left >= 0 &&
        bounding.bottom <=
          (window.innerHeight || document.documentElement.clientHeight) &&
        bounding.right <=
          (window.innerWidth || document.documentElement.clientWidth)
    );
  }

  setActiveDescendant(option) {
    if (option && this.listboxHasVisualFocus) {
      this.comboboxNode.setAttribute('aria-activedescendant', option.id);
      if (!this.isOptionInView(option)) {
        option.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    } else {
      this.comboboxNode.setAttribute('aria-activedescendant', '');
    }
  }

  setValue(value) {
    this.filter = value.textContent;
    this.dataset = value.dataset;
    console.log(this.dataset);
    this.comboboxNode.value = this.filter;
    this.comboboxNode.setSelectionRange(this.filter.length, this.filter.length);
    this.filterOptions();

    outputSchoolData(this);
  }

  setOption(option, flag) {
    if (typeof flag !== 'boolean') {
      flag = false;
    }

    if (option) {
      this.option = option;
      this.setCurrentOptionStyle(this.option);
      this.setActiveDescendant(this.option);

      if (this.isBoth) {
        this.comboboxNode.value = this.option.textContent;
        if (flag) {
          this.comboboxNode.setSelectionRange(
            this.option.textContent.length,
            this.option.textContent.length
          );
        } else {
          this.comboboxNode.setSelectionRange(
            this.filter.length,
            this.option.textContent.length
          );
        }
      }
    }
  }

  setVisualFocusCombobox() {
    this.listboxNode.classList.remove('focus');
    this.comboboxNode.parentNode.classList.add('focus'); // set the focus class to the parent for easier styling
    this.comboboxHasVisualFocus = true;
    this.listboxHasVisualFocus = false;
    this.setActiveDescendant(false);
  }

  setVisualFocusListbox() {
    this.comboboxNode.parentNode.classList.remove('focus');
    this.comboboxHasVisualFocus = false;
    this.listboxHasVisualFocus = true;
    this.listboxNode.classList.add('focus');
    this.setActiveDescendant(this.option);
  }

  removeVisualFocusAll() {
    this.comboboxNode.parentNode.classList.remove('focus');
    this.comboboxHasVisualFocus = false;
    this.listboxHasVisualFocus = false;
    this.listboxNode.classList.remove('focus');
    this.option = null;
    this.setActiveDescendant(false);
  }

  // ComboboxAutocomplete Events

  filterOptions() {
    // do not filter any options if autocomplete is none
    if (this.isNone) {
      this.filter = '';
    }

    var option = null;
    var currentOption = this.option;
    var filter = this.filter.toLowerCase();

    this.filteredOptions = [];
    this.listboxNode.innerHTML = '';

    for (var i = 0; i < this.allOptions.length; i++) {
      option = this.allOptions[i];
      if (
        filter.length === 0 ||
          this.getLowercaseContent(option).indexOf(filter) === 0
      ) {
        this.filteredOptions.push(option);
        this.listboxNode.appendChild(option);
      }
    }

    // Use populated options array to initialize firstOption and lastOption.
    var numItems = this.filteredOptions.length;
    if (numItems > 0) {
      this.firstOption = this.filteredOptions[0];
      this.lastOption = this.filteredOptions[numItems - 1];

      if (currentOption && this.filteredOptions.indexOf(currentOption) >= 0) {
        option = currentOption;
      } else {
        option = this.firstOption;
      }
    } else {
      this.firstOption = null;
      option = null;
      this.lastOption = null;
    }

    return option;
  }

  setCurrentOptionStyle(option) {
    for (var i = 0; i < this.filteredOptions.length; i++) {
      var opt = this.filteredOptions[i];
      if (opt === option) {
        opt.setAttribute('aria-selected', 'true');
        if (
          this.listboxNode.scrollTop + this.listboxNode.offsetHeight <
            opt.offsetTop + opt.offsetHeight
        ) {
          this.listboxNode.scrollTop =
            opt.offsetTop + opt.offsetHeight - this.listboxNode.offsetHeight;
        } else if (this.listboxNode.scrollTop > opt.offsetTop + 2) {
          this.listboxNode.scrollTop = opt.offsetTop;
        }
      } else {
        opt.removeAttribute('aria-selected');
      }
    }
  }

  getPreviousOption(currentOption) {
    if (currentOption !== this.firstOption) {
      var index = this.filteredOptions.indexOf(currentOption);
      return this.filteredOptions[index - 1];
    }
    return this.lastOption;
  }

  getNextOption(currentOption) {
    if (currentOption !== this.lastOption) {
      var index = this.filteredOptions.indexOf(currentOption);
      return this.filteredOptions[index + 1];
    }
    return this.firstOption;
  }

  /* MENU DISPLAY METHODS */

  doesOptionHaveFocus() {
    return this.comboboxNode.getAttribute('aria-activedescendant') !== '';
  }

  isOpen() {
    return this.listboxNode.style.display === 'block';
  }

  isClosed() {
    return this.listboxNode.style.display !== 'block';
  }

  hasOptions() {
    return this.filteredOptions.length;
  }

  open() {
    this.listboxNode.style.display = 'block';
    this.comboboxNode.setAttribute('aria-expanded', 'true');
    this.buttonNode.setAttribute('aria-expanded', 'true');
  }

  close(force) {
    if (typeof force !== 'boolean') {
      force = false;
    }

    if (
      force ||
        (!this.comboboxHasVisualFocus &&
          !this.listboxHasVisualFocus &&
          !this.hasHover)
    ) {
      this.setCurrentOptionStyle(false);
      this.listboxNode.style.display = 'none';
      this.comboboxNode.setAttribute('aria-expanded', 'false');
      this.buttonNode.setAttribute('aria-expanded', 'false');
      this.setActiveDescendant(false);
      this.comboboxNode.parentNode.classList.add('focus');
    }
  }

  /* combobox Events */

  onComboboxKeyDown(event) {
    var flag = false,
    altKey = event.altKey;

    if (event.ctrlKey || event.shiftKey) {
      return;
    }

    switch (event.key) {
      case 'Enter':
        if (this.listboxHasVisualFocus) {
          this.setValue(this.option);
        } else {
          console.log("Entered on text",this);
          outputSchoolData(this);
        }
        this.close(true);
        this.setVisualFocusCombobox();
        flag = true;
        break;

      case 'Down':
      case 'ArrowDown':
        if (this.filteredOptions.length > 0) {
          if (altKey) {
            this.open();
          } else {
            this.open();
            if (
              this.listboxHasVisualFocus ||
                (this.isBoth && this.filteredOptions.length > 1)
            ) {
              this.setOption(this.getNextOption(this.option), true);
              this.setVisualFocusListbox();
            } else {
              this.setOption(this.firstOption, true);
              this.setVisualFocusListbox();
            }
          }
        }
        flag = true;
        break;

      case 'Up':
      case 'ArrowUp':
        if (this.hasOptions()) {
          if (this.listboxHasVisualFocus) {
            this.setOption(this.getPreviousOption(this.option), true);
          } else {
            this.open();
            if (!altKey) {
              this.setOption(this.lastOption, true);
              this.setVisualFocusListbox();
            }
          }
        }
        flag = true;
        break;

      case 'Esc':
      case 'Escape':
        if (this.isOpen()) {
          this.close(true);
          this.filter = this.comboboxNode.value;
          this.filterOptions();
          this.setVisualFocusCombobox();
        } else {
          this.setValue('');
          this.comboboxNode.value = '';
        }
        this.option = null;
        flag = true;
        break;

      case 'Tab':
        this.close(true);
        if (this.listboxHasVisualFocus) {
          if (this.option) {
            this.setValue(this.option.textContent);
          }
        }
        break;

      case 'Home':
        this.comboboxNode.setSelectionRange(0, 0);
        flag = true;
        break;

      case 'End':
        var length = this.comboboxNode.value.length;
        this.comboboxNode.setSelectionRange(length, length);
        flag = true;
        break;

      default:
        break;
    }

    if (flag) {
      event.stopPropagation();
      event.preventDefault();
    }
  }

  isPrintableCharacter(str) {
    return str.length === 1 && str.match(/\S| /);
  }

  onComboboxKeyUp(event) {
    var flag = false,
    option = null,
    char = event.key;

    if (this.isPrintableCharacter(char)) {
      this.filter += char;
    }

    // this is for the case when a selection in the textbox has been deleted
    if (this.comboboxNode.value.length < this.filter.length) {
      this.filter = this.comboboxNode.value;
      this.option = null;
      this.filterOptions();
    }

    if (event.key === 'Escape' || event.key === 'Esc') {
      return;
    }

    switch (event.key) {
      case 'Backspace':
        this.setVisualFocusCombobox();
        this.setCurrentOptionStyle(false);
        this.filter = this.comboboxNode.value;
        this.option = null;
        this.filterOptions();
        flag = true;
        break;

      case 'Left':
      case 'ArrowLeft':
      case 'Right':
      case 'ArrowRight':
      case 'Home':
      case 'End':
        if (this.isBoth) {
          this.filter = this.comboboxNode.value;
        } else {
          this.option = null;
          this.setCurrentOptionStyle(false);
        }
        this.setVisualFocusCombobox();
        flag = true;
        break;

      default:
        if (this.isPrintableCharacter(char)) {
          this.setVisualFocusCombobox();
          this.setCurrentOptionStyle(false);
          flag = true;

          if (this.isList || this.isBoth) {
            option = this.filterOptions();
            if (option) {
              if (this.isClosed() && this.comboboxNode.value.length) {
                this.open();
              }

              if (
                this.getLowercaseContent(option).indexOf(
                  this.comboboxNode.value.toLowerCase()
                ) === 0
              ) {
                this.option = option;
                if (this.isBoth || this.listboxHasVisualFocus) {
                  this.setCurrentOptionStyle(option);
                  if (this.isBoth) {
                    this.setOption(option);
                  }
                }
              } else {
                this.option = null;
                this.setCurrentOptionStyle(false);
              }
            } else {
              this.close();
              this.option = null;
              this.setActiveDescendant(false);
            }
          } else if (this.comboboxNode.value.length) {
            this.open();
          }
        }

        break;
    }

    if (flag) {
      event.stopPropagation();
      event.preventDefault();
    }
  }

  onComboboxClick() {
    if (this.isOpen()) {
      this.close(true);
    } else {
      this.open();
    }
  }

  onComboboxFocus() {
    this.filter = this.comboboxNode.value;
    this.filterOptions();
    this.setVisualFocusCombobox();
    this.option = null;
    this.setCurrentOptionStyle(null);
  }

  onComboboxBlur() {
    this.removeVisualFocusAll();
  }

  onBackgroundPointerUp(event) {
    if (
      !this.comboboxNode.contains(event.target) &&
        !this.listboxNode.contains(event.target) &&
        !this.buttonNode.contains(event.target)
    ) {
      this.comboboxHasVisualFocus = false;
      this.setCurrentOptionStyle(null);
      this.removeVisualFocusAll();
      setTimeout(this.close.bind(this, true), 300);
    }
  }

  onButtonClick() {
    if (this.isOpen()) {
      this.close(true);
    } else {
      this.open();
    }
    this.comboboxNode.focus();
    this.setVisualFocusCombobox();
  }

  /* Listbox Events */

  onListboxPointerover() {
    this.hasHover = true;
  }

  onListboxPointerout() {
    this.hasHover = false;
    setTimeout(this.close.bind(this, false), 300);
  }

  // Listbox Option Events

  onOptionClick(event) {
    this.comboboxNode.value = event.target.textContent;
    this.close(true);
  }

  onOptionPointerover() {
    this.hasHover = true;
    this.open();
  }

  onOptionPointerout() {
    this.hasHover = false;
    setTimeout(this.close.bind(this, false), 300);
  }
}

// Initialize comboboxes

window.addEventListener('data', function () {
  var comboboxes = document.querySelectorAll('.combobox-list');
  for (var i = 0; i < comboboxes.length; i++) {
    var combobox = comboboxes[i];
    var comboboxNode = combobox.querySelector('input');
    var buttonNode = combobox.querySelector('button');
    var listboxNode = combobox.querySelector('[role="listbox"]');
    new ComboboxAutocomplete(comboboxNode, buttonNode, listboxNode);
  }
});

function reportMessage(e) {
    const schoolData = {
      name: e.target.dataset.schoolName.trim(),
      members: e.target.dataset.members,
      vacancies: e.target.dataset.vacancies
    }
  identifyModalContent(schoolData);
  openModal();
}
</script>


    <style>
#modal {
  width: calc(100vw - 40px);
  max-width: 500px;
  padding: 0;
}
#modal .modal-inner {
  position: relative;
  padding: 40px;
}
#modal .modal-close {
  position: absolute;
  top: 10px;
  right: 10px;
  border: 1px solid #777777;
  border-radius: 50%;
  line-height: 0.8;
  font-size: 14px;
  padding: 3px 4px;
}
#modal #stepper {
  padding: 0;
  margin: 0 auto 20px auto;
  display: flex;
  align-content: center;
  justify-content: center;
  width: calc(100% - 40px);
}
#modal #stepper span:nth-child(odd) {
  width: 20vw;
  height: 22px;
  max-width: 90px;
  padding: 3px 6px;
  border: 1px solid #777777;
  border-radius: 6px;
  font-size: 12px;
  line-height: 1.25;
  text-align: center;
}
#modal #stepper span:nth-child(even) {
  height: 11px;
  width: 11px;
  border-bottom: 1px solid #777777;
}
#modal #stepper span:last-child {
  padding-left: 2px;
  border: none;
  text-align: left;
}
#modal #stepper span.current {
  background: #aaccee;
  font-weight: 700;
}
@media screen and (min-width : 840px) {
  #modal .modal-inner {
    padding: 40px 20px;
  }
}
</style>
<script>
function completeModalContent (emailAddress,schoolData) {
  let modalContentHTML = `
<div id="stepper"><span class="identify">Identify</span><span></span><span class="testify">Testify</span><span></span><span class="verify">Verify</span><span></span><span class="review">Review</span><span></span><span class="done" style="font-weight: bold;">Done!</span></div>
<p>Thank you for contributing to our tracker</p>
<h3>One more thing!</h3>
<p>In order to ensure no one pretends to be you, we will send you a confirmation email with this information. In order for us to use the entry that you submitted, you <strong>must</strong> click the confirmation button in the email we&rsquo;ll send you. Keep an eye out in your inbox and spam folder, just in case.
</p>
<button type="submit" id="emailMatch" style="width: 100px;">Check Email</button>
</p>
</div>
<div class="if no">
<p>We can help you find out!</p>
<p>You’ll need a few things… {very cursory explanation}</p>
<p>Go to our <a href="https://example.com">vacancy investigation page</a> to learn more.</p>
</div>
<style>.knowledge {min-height: 280px} .if {display: none;} .knowledge input.no:checked ~ .if.no {display: block;} .knowledge input.yes:checked ~ .if.yes {display: block;}</style>

`
  modalContentBox.innerHTML = modalContentHTML;
  const modalForm = document.querySelector("#modal-form");
  modalForm.removeEventListener("submit", ajaxSubmitEmail);
  modalForm.addEventListener("submit", ajaxSubmitEmail);
}
function reviewModalContent (emailAddress,schoolData) {
  let modalContentHTML = `
<div id="stepper"><span class="identify current">Identify</span><span></span><span class="testify">Testify</span><span></span><span class="verify">Verify</span><span></span><span class="review">Review</span><span></span><span class="done">Done!</span></div>
<p>Info will go here.</p>
    <button type="submit" id="nextToDone" style="width: 100px;">Review Your Response</button>
<style>.knowledge {min-height: 280px} .if {display: none;} .knowledge input.no:checked ~ .if.no {display: block;} .knowledge input.yes:checked ~ .if.yes {display: block;}</style>

`
  modalContentBox.innerHTML = modalContentHTML;
  const modalForm = document.querySelector("#modal-form");
  modalForm.removeEventListener("submit", ajaxSubmitEmail);
  modalForm.addEventListener("submit", () => comleteModalContent(emailAddress,schoolData,userData));
}
function verifyModalContent (emailAddress,schoolData,userData) {
  let modalContentHTML = `
<div id="stepper"><span class="identify">Identify</span><span></span><span class="testify">Testify</span><span></span><span class="verify current">Verify</span><span></span><span class="review">Review</span><span></span><span class="done">Done!</span></div>
<p>CTU put this page together using data sent to us by CPS Central Office. But, no one knows each school like the educators that work there.</p>
<h3>Share your knowledge</h3>
<p>Do you know for a fact how many educators work in ${schoolData.name} and how many positions aren’t filled?
</p>
<div class="knowledge">
<input type="radio" name="knowledge" value="yes" class="yes" id="knowledgeYes"></input><label for="knowledgeYes">Yes</label>
<input type="radio" name="knowledge" value="no" class="no" id="knowledgeNo"></input><label for="knowledgeNo">No</label>
<div class="if yes">
<p>Great! Please take a minute to either confirm or correct the CPS information on ${schoolData.name} for us.</p>
<style>
 .borderless tr:has(input.change.button) + tr {display:none}
 .borderless tr:has(input.change.button:checked) + tr {display:table-row}
 .change.button {visibility: hidden}
 .change.button + label {font-size:.6em; border: none; background: transparent; text-decoration: underline; color: #db1f2a}
 .borderless tr, .borderless td {border:none; padding: 0;}
 .borderless td:first-child {white-space: nowrap; padding-right: 1em;}
.borderless td:nth-child(2), .borderless td:nth-child(2) input {width: 4em; text-align: right;}
</style>
<table class="borderless"><tbody>
<tr><td>Total CTU members:</td><td>${schoolData.members}</td><td><input type="checkbox" id="showFirstNameChange" class="change button"><label for="showFirstNameChange">change</label></td></tr>
  <tr><td>&nbsp;Change to:</td><td><input type="text" id="changeFirstName" name="changeFirstName"></input></td><td></td></tr>
<tr><td>Total Vacancies:</td><td>${schoolData.vacancies}</td><td><input type="checkbox" id="showLastNameChange" class="change button"><label for="showLastNameChange">change</label></td></tr>
<tr><td>&nbsp;Change to:</td><td><input type="text" id="changeLastName" name="changeLastName"></input></td><td></td></tr>
</tbody></table>
    <button type="submit" id="nextToReview" style="width: 100px;">Review Your Response</button>
</div>
<div class="if no">
<p>We can help you find out!</p>
<p>You’ll need a few things… {very cursory explanation}</p>
<p>Go to our <a href="https://example.com">vacancy investigation page</a> to learn more.</p>
</div>
</div>
<style>.knowledge {min-height: 280px} .if {display: none;} .knowledge input.no:checked ~ .if.no {display: block;} .knowledge input.yes:checked ~ .if.yes {display: block;}</style>

`
  modalContentBox.innerHTML = modalContentHTML;
  const modalForm = document.querySelector("#modal-form");
  modalForm.removeEventListener("submit", ajaxSubmitEmail);
  modalForm.addEventListener("submit", () => reviewModalContent(emailAddress,schoolData,userData));
}
function testifyModalContent (emailAddress,schoolData,userData) {
  console.log("School Data in Testify:",schoolData);
  let modalContentHTML = `
<div id="stepper"><span class="identify">Identify</span><span></span><span class="testify current">Testify</span><span></span><span class="verify">Verify</span><span></span><span class="review">Review</span><span></span><span class="done">Done!</span></div>
<style>
 .borderless tr:has(input.change.button) + tr {display:none}
 .borderless tr:has(input.change.button:checked) + tr {display:table-row}
 .change.button {visibility: hidden}
 .change.button + label {font-size:.6em; border: none; background: transparent; text-decoration: underline; color: #db1f2a}
 .borderless tr, .borderless td {border:none; padding: 0;}
 .borderless td:first-child {white-space: nowrap;}
.toggleRadio {visibility: hidden;}
</style>
<h2>Confirm your information</h2>
<p>Our records show the following information for your email address. If any of these items are change or have changed, please click the link at right that say &ldquo;change&rdquo; to enter the correct information.
</p>
<table class="borderless"><tbody>
<tr><td>First Name:</td><td>${userData.firstName}</td><td><input type="checkbox" id="showFirstNameChange" class="change button"><label for="showFirstNameChange">change</label></td></tr>
  <tr><td>&nbsp;Change to:</td><td colspan="2" style="width: 100%;"><input type="text" id="changeFirstName" name="changeFirstName"></input></td></tr>
<tr><td>Last Name:</td><td>${userData.lastName}</td><td><input type="checkbox" id="showLastNameChange" class="change button"><label for="showLastNameChange">change</label></td></tr>
<tr><td>&nbsp;Change to:</td><td colspan="2" style="width: 100%;"><input type="text" id="changeLastName" name="changeLastName"></input></td></tr>
<tr><td>School Name:&nbsp;</td><td>${userData.school}</td><td><input type="checkbox" id="showSchoolChange" class="change button"><label for="showSchoolChange">change</label></td></tr>
<tr><td>&nbsp;Change to:</td><td colspan="2" style="width: 100%;"><input type="text" id="changeSchool" name="changeSchool"></input></td></tr>
<tr><td>Position</td><td>${userData.jobTitle}</td><td><input type="checkbox" id="showPositionChange" class="change button"><label for="showPositionChange">change</label></td></tr>
<tr><td>&nbsp;Change to:</td><td colspan="2" style="width: 100%;"><input type="text" id="changePosition" name="changePosition"></input></td></tr>
</tbody></table>
<h2>Tell Us Your Story</h2>
<p>
<label for=yourStory>
How do these vacancies affect your classroom or the work you do at the school(s)? Are students harmed at all due to these vacancies?
</label>
</p>
<textarea name="yourStory" id="yourStory" class="longform" style="width: 100%; max-width: 454px; height: 6em;"></textarea>
<p><label for="shareStory">Can we share your story on this tracker?</label> <input name="shareStory" id="yesShareStory" class="yes shareStory" type="radio"><label for="yesShareStory">Yes</label>
<input name="shareStory" id="noShareStory" class="no shareStory" type="radio"><label for="noShareStory">No</label>
</p>
<p><label>Does your school have an active Professional Problems Committee (PPC)? </label>
<input name="hasPPC" id="yesHasPPC" class="yes hasPPC" type="radio"><label for="yesHasPPC">Yes</label>
<input name="hasPPC" id="noHasPPC" class="no hasPPC" type="radio"><label for="noHasPPC">No</label>
<input name="hasPPC" id="unsureHasPPC" class="unsure hasPPC" type="radio"><label for="unsureHasPPC">Unsure</label>
</p>
<p><label>Does your school have an active Professional Personnel Leadership Committee (PPLC)? </label>
<input name="hasPPLC" id="yesHasPPLC" class="yes hasPPLC" type="radio"><label for="yesHasPPLC">Yes</label>
<input name="hasPPLC" id="noHasPPLC" class="no hasPPLC" type="radio"><label for="noHasPPLC">No</label>
<input name="hasPPLC" id="unsureHasPPLC" class="unsure hasPPLC" type="radio"><label for="unsureHasPPLC">Unsure</label>
</p>
<div id="isWorking" class="isWorking"><p><span class="one">Is</span><span style="display:none;" class="both">Are</span> the <span class="hasPPC">PPC</span> <span class="both">and/or</span> <span class="hasPPLC">PPLC</span> working on this vacancy issue?
<span style="display:block;">
<input name="isWorking" id="yesIsWorking" class="yes isWorking" type="radio"><label for="yesIsWorking">Yes</label>
<input name="isWorking" id="noIsWorking" class="no isWorking" type="radio"><label for="noIsWorking">No</label>
<input name="isWorking" id="unsureIsWorking" class="unsure isWorking" type="radio"><label for="unsureIsWorking">Unsure</label>
</span></p>
</div>
<style>
.yesHasPPC:not(:checked):has(~ .yesHasPPLC:not(:checked)) ~ div#isWorking) {display:none;}
input.hasPPC, input.hasPPLC {display: inline;}
.yesHasPPC:checked ~ span.hasPPC, .yesHasPPLC:checked ~ span.hasPPC {display: inline;}
.yesHasPPC:checked ~ .noHasPPLC:checked ~ .one,
.yesHasPPC:checked ~ .unsureHasPPLC:checked ~ .one,
.noHasPPC:checked ~ .yesHasPPLC:checked ~ .one,
.unsureHasPPC:checked ~ .yesHasPPLC:checked ~ .one {display: inline;}
.yesHasPPC:checked ~ .yesHasPPLC:checked ~ .both, {display:inline;}
</style>
<p>Is your principal/administrator actively working to fill these positions?
<span style="display:block;">
<input name="isWorking" id="yesIsWorking" class="yes isWorking" type="radio"><label for="yesIsWorking">Yes</label>
<input name="isWorking" id="noIsWorking" class="no isWorking" type="radio"><label for="noIsWorking">No</label>
<input name="isWorking" id="unsureIsWorking" class="unsure isWorking" type="radio"><label for="unsureIsWorking">Unsure</label>
</span>
</p>
<p>Is there any other information you want to share confidentially with organizers?</p>
<p>
<textarea name="tellOrganizer" id="tellOrganizer" class="tellOrganizer" style="width: 100%; max-width: 454px; height: 6em;"></textarea>
</p>
    <button type="submit" id="nextToVerify" style="width: 100px;">Next Section</button>
<style>.knowledge {min-height: 280px} .if {display: none;} .knowledge input.no:checked ~ .if.no {display: block;} .knowledge input.yes:checked ~ .if.yes {display: block;}</style>

`
  modalContentBox.innerHTML = modalContentHTML;
  const modalForm = document.querySelector("#modal-form");
  modalForm.addEventListener("submit", () => verifyModalContent(emailAddress,schoolData,userData));
}
function waitingModalContent (emailAddress,schoolData) {
  let modalContentHTML = `
<div id="stepper"><span class="identify current">Identify</span><span></span><span class="testify">Testify</span><span></span><span class="verify">Verify</span><span></span><span class="review">Review</span><span></span><span class="done">Done!</span></div>
<p style="text-align: center;">Matching ${emailAddress} to your record.</p>
<p style="text-align: center;"><svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><style>.spinner_OSmW{transform-origin:center;animation:spinner_T6mA 1.75s step-end infinite}@keyframes spinner_T6mA{8.3%{transform:rotate(30deg)}16.6%{transform:rotate(60deg)}25%{transform:rotate(90deg)}33.3%{transform:rotate(120deg)}41.6%{transform:rotate(150deg)}50%{transform:rotate(180deg)}58.3%{transform:rotate(210deg)}66.6%{transform:rotate(240deg)}75%{transform:rotate(270deg)}83.3%{transform:rotate(300deg)}91.6%{transform:rotate(330deg)}100%{transform:rotate(360deg)}}</style><g class="spinner_OSmW"><rect x="11" y="1" width="2" height="5" opacity=".14"/><rect x="11" y="1" width="2" height="5" transform="rotate(30 12 12)" opacity=".29"/><rect x="11" y="1" width="2" height="5" transform="rotate(60 12 12)" opacity=".43"/><rect x="11" y="1" width="2" height="5" transform="rotate(90 12 12)" opacity=".57"/><rect x="11" y="1" width="2" height="5" transform="rotate(120 12 12)" opacity=".71"/><rect x="11" y="1" width="2" height="5" transform="rotate(150 12 12)" opacity=".86"/><rect x="11" y="1" width="2" height="5" transform="rotate(180 12 12)"/></g></svg>
</p>
</div>
`
  modalContentBox.innerHTML = modalContentHTML;
  window.setTimeout(() => {matchingModal (emailAddress,schoolData)},2000);
}
function matchingModal (emailAddress,schoolData) {
  console.log("Matching Modal top emailAddress:",emailAddress);
  const email = emailAddress.trim().toLowerCase();
  if (email === "unionkimmy@gmail.com") {
testifyModalContent(email,schoolData,{firstName:"Kimberly",lastName:"Goldbaum",school:"Collins HS",memberId:"14326",jobCode:"500629",jobTitle:"Special Education Teacher"})
  } else {
    unmatchedModal (email,schoolData);
  }
}
function unmatchedModal (emailAddress,schoolData) {
  let modalContentHTML = `
<div id="stepper"><span class="identify current">Identify</span><span></span><span class="testify">Testify</span><span></span><span class="verify">Verify</span><span></span><span class="review">Review</span><span></span><span class="done">Done!</span></div>
  <h2>Unmatched Email Address</h2>
  <p style="margin-bottom:0.25em;">The email address that you entered:
  </p>
  <p style="font-family: mono; margin: 0.25em 2em;">${emailAddress}
  </p>
  <p style="margin-top: 0.25em;">was not found in our records.</p>
  <p>If you mistyped the email address, please try again below.
  </p>
  <p>If you are new to CPS, please note that you must sign yourself up for the Chicago Teachers Union, membership is not automatic. Please click <a href="https://members.ctulocal1.org/CTUMembershipApplication.aspx">ctulocal1.org/join</a> to complete our online membership card.</p>
  <p>If you believe the address that you entered <em>should</em> be in the Union&rsquo;s records, please email the <a href="mailto:Membership@ctulocal1.org">Membership Department</a> with a correction, including your name, school, CPS Employee ID number and correct email address and phone number(s).
  </p>
  <p style="margin: 24px 0 6px 0; padding: 0;">
    <label for="personalEmail" style="font-weight: bold; color: #444444;">Your personal email</label>
  </p>
  <p>
    <input type="email" name="personalEmail" id="personalEmail" style="width: calc(100% - 120px);">
    <button type="submit" id="emailMatch" style="width: 100px;">Check Email</button>
  </p>
</div>
`
//    console.log("SchoolData identifyModal:",JSON.stringify(schoolData));
  modalContentBox.innerHTML = modalContentHTML;
  const modalForm = document.querySelector("#modal-form");
  modalForm.removeEventListener("submit", (e) => {ajaxSubmitEmail(e,schoolData)});
  modalForm.addEventListener("submit", (e) => {ajaxSubmitEmail(e,schoolData)});
}

function identifyModalContent (schoolData) {
  let modalContentHTML = `
<div id="stepper"><span class="identify current">Identify</span><span></span><span class="testify">Testify</span><span></span><span class="verify">Verify</span><span></span><span class="review">Review</span><span></span><span class="done">Done!</span></div>
<h2>Share Your Story</h2>
<p>We want to know how staffing at your school affects your students and your work. Tell us your story and then, if you have the information, help us verify the numbers that CPS sent us.</p>
<p>We’ll only accept information from verified members of the CTU. Provide the email where you get CTU messages, like our weekly bulletin. We will check it against our roster of CTU member emails.</p>
<p style="margin: 24px 0 6px 0; padding: 0;"><label for="personalEmail" style="font-weight: bold; color: #444444;">Your personal email</label></p>
<p>
<input type="email" name="personalEmail" id="personalEmail" style="width: calc(100% - 120px);">
<button type="submit" id="emailMatch" style="width: 100px;">Check Email</button>
</p>
</div>
`
//    console.log("SchoolData identifyModal:",JSON.stringify(schoolData));
  modalContentBox.innerHTML = modalContentHTML;
  const modalForm = document.querySelector("#modal-form");
  modalForm.reset();
  modalForm.removeEventListener("submit", (e) => {ajaxSubmitEmail(e,schoolData)});
  modalForm.addEventListener("submit", (e) => {ajaxSubmitEmail(e,schoolData)});
}
async function ajaxSubmitEmail (e,schoolData) {
  e.preventDefault();
  // console.log("Form Submission",e,"SchoolData?",schoolData);
  const formData = new FormData(e.target);
  console.log("ajaxSubmit FormData:",formData);
  const sentData = Object.fromEntries(formData);
  const emailAddress = sentData.personalEmail;
  console.log("ajaxSubmit SchoolData:",schoolData,"emailAddress:",emailAddress)
  waitingModalContent (emailAddress,schoolData);
}
</script>
  </body>
</html>
